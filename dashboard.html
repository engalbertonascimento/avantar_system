<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Avantar - Dashboard Gestor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-top: 5px solid #004a8d; }
        .card h3 { margin: 0; color: #666; font-size: 13px; text-transform: uppercase; }
        .card p { margin: 10px 0 0; font-size: 26px; font-weight: bold; color: #004a8d; }
        
        .card.alerta { border-top-color: #d32f2f; }
        .card.alerta p { color: #d32f2f; }
        .card.sucesso { border-top-color: #2e7d32; }
        .card.sucesso p { color: #2e7d32; }
        .card.info { border-top-color: #6f42c1; }
        .card.info p { color: #6f42c1; }
        
        .graficos-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* CORRE√á√ÉO AQUI: Altura fixa e position relative para o Chart.js n√£o bugar */
        .chart-box { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            height: 350px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
        }
        
        canvas { max-width: 100% !important; max-height: 100% !important; }
        h4 { margin-top: 0; color: #333; text-align: center; }
        
        .btn-print { background: #555; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; float: right; }
        @media print { .btn-print { display: none; } }
    </style>
</head>
<body>

    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
    <h2>üìä Painel Gerencial - Avantar</h2>
    
    <div class="grid">
        <div class="card">
            <h3>Total de Vidas</h3>
            <p id="totalVidas">0</p>
        </div>
        <div class="card sucesso">
            <h3>Potencial Financeiro</h3>
            <p id="totalValor">R$ 0,00</p>
        </div>
        <div class="card alerta">
            <h3>Retornos Atrasados</h3>
            <p id="totalAtrasados">0</p>
        </div>
        <div class="card info">
            <h3>Leads Parados</h3>
            <p id="totalParados">0</p>
        </div>
        <div class="card">
            <h3>Convers√£o</h3>
            <p id="taxaConversao">0%</p>
        </div>
    </div>

    <div class="graficos-container">
        <div class="chart-box">
            <h4>Cota√ß√µes por Operadora</h4>
            <div style="flex-grow:1; position:relative;">
                <canvas id="chartOperadoras"></canvas>
            </div>
        </div>
        <div class="chart-box">
            <h4>Distribui√ß√£o por Status</h4>
            <div style="flex-grow:1; position:relative;">
                <canvas id="chartStatus"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis para destruir os gr√°ficos antes de recriar
        let chartOp = null;
        let chartSt = null;

        function carregarIndicadores() {
            fetch('actions/listar_contatos.php')
            .then(res => res.json())
            .then(data => {
                let vidas = 0, valor = 0, atrasados = 0, realizados = 0, parados = 0;
                let contagemOperadoras = {}, contagemStatus = {};
                const hoje = new Date().toISOString().split('T')[0];

                data.forEach(c => {
                    vidas += parseInt(c.qtd_vidas || 0);
                    valor += parseFloat(c.valor_cotacao || 0);
                    
                    if(c.status_contato === 'Contato realizado') realizados++;
                    
                    if(c.data_retorno_prevista < hoje && 
                       c.status_contato !== 'Contato realizado' && 
                       c.status_contato !== 'Cliente desistiu' &&
                       c.data_retorno_prevista !== '0000-00-00' && 
                       c.data_retorno_prevista !== null) {
                        atrasados++;
                    }

                    if(c.status_contato === 'Novo' && (!c.observacoes || c.observacoes.trim() === "")) {
                        parados++;
                    }

                    let op = c.operadora || 'N√£o informada';
                    contagemOperadoras[op] = (contagemOperadoras[op] || 0) + 1;

                    let st = c.status_contato || 'Sem Status';
                    contagemStatus[st] = (contagemStatus[st] || 0) + 1;
                });

                document.getElementById('totalVidas').innerText = vidas.toLocaleString('pt-BR');
                document.getElementById('totalValor').innerText = 'R$ ' + valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('totalAtrasados').innerText = atrasados;
                document.getElementById('totalParados').innerText = parados;
                document.getElementById('taxaConversao').innerText = (data.length > 0 ? ((realizados / data.length) * 100).toFixed(1) : 0) + '%';

                // CORRE√á√ÉO: Destruir inst√¢ncias antigas antes de renderizar novas
                if(chartOp) chartOp.destroy();
                if(chartSt) chartSt.destroy();

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                };

                chartOp = new Chart(document.getElementById('chartOperadoras'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(contagemOperadoras),
                        datasets: [{
                            data: Object.values(contagemOperadoras),
                            backgroundColor: ['#004a8d', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997']
                        }]
                    },
                    options: commonOptions
                });

                chartSt = new Chart(document.getElementById('chartStatus'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(contagemStatus),
                        datasets: [{
                            label: 'Qtd Clientes',
                            data: Object.values(contagemStatus),
                            backgroundColor: '#004a8d'
                        }]
                    },
                    options: { 
                        ...commonOptions,
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            });
        }
        window.onload = carregarIndicadores;
    </script>
</body>
</html>